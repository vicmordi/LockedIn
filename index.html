<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Locked In ‚Äî Minimal Focus (PIN + Tap-to-main)</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{
    --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --danger:#ef4444; --ok:#22c55e; --ring: rgba(34,211,238,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 900px at 50% -200px,#0e1a31 0%,#0b1220 55%,#09101d 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:16px}
  .app{width:min(980px,100%)} .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:10px}.dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px var(--accent)}
  h1{font-size:18px;margin:0;letter-spacing:.4px;color:#e2e8f0} .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px} @media(min-width:760px){.grid{grid-template-columns:1.2fr .8fr}}
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);color:var(--text);font-weight:600;cursor:pointer;user-select:none;transition:transform .05s ease}
  .chip:active{transform:scale(.98)} .chip[data-active="true"]{outline:2px solid var(--ring);background:rgba(34,211,238,.08)}
  input[type="number"],input[type="tel"],input[type="password"],select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0c1426;color:var(--text)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.09);background:linear-gradient(180deg,#0fbad0,#0aa6c2);color:#062028;font-weight:800;letter-spacing:.3px;cursor:pointer;box-shadow:0 10px 18px rgba(34,211,238,.15)}
  .btn:active{transform:translateY(1px)} .btn-ghost{background:transparent;color:var(--text)}
  .timer{display:flex;align-items:center;justify-content:center;font-variant-numeric:tabular-nums;font-weight:900;text-align:center;letter-spacing:1px;user-select:none;font-size:clamp(42px,11vw,140px);padding:18px 8px}
  .sub{font-size:13px;color:var(--muted);text-align:center;margin-top:-6px}
  .progress{height:10px;background:#0c1426;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#22c55e)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.08);color:var(--muted)}
  .history{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow:auto}
  .hrow{display:flex;justify-content:space-between;align-items:center;font-size:14px;border-bottom:1px dashed rgba(255,255,255,.08);padding:8px 0}
  .ok{color:var(--ok)} .bad{color:var(--danger)}
  .note{font-size:12px;color:var(--muted)}

  /* Focus Shield (PIN / Emergency) */
  .shield{position:fixed;inset:0;background:rgba(5,10,18,.86);backdrop-filter:blur(4px);display:none;z-index:9999;touch-action:none}
  .shield[aria-hidden="false"]{display:block}
  .shield-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:22px}
  .emergency{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .emergency a{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.08);text-decoration:none;font-weight:700}
  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:min(360px,90vw)}
  .kbtn{padding:14px 0;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0d1729;color:#e5e7eb;font-size:20px;font-weight:700}

  /* Break Shield */
  .breakShield{position:fixed;inset:0;background:radial-gradient(900px 600px at 50% -120px,#10261f,#0a1713);display:none;z-index:10000;touch-action:none}
  .breakShield[aria-hidden="false"]{display:flex}
  .breakBox{margin:auto;display:flex;flex-direction:column;align-items:center;gap:16px;padding:24px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:18px;width:min(680px,92vw)}
  .holdBtn{user-select:none;position:relative;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:#0e1f1a;color:#d1fae5;font-weight:800;width:100%;max-width:360px;text-align:center}
  .holdFill{position:absolute;inset:0;width:0%;height:100%;background:rgba(34,197,94,.25);border-radius:14px;pointer-events:none}

  /* Minimal countdown overlay */
  .minimalOverlay{
    position:fixed; inset:0; display:none; z-index:8888;
    background:radial-gradient(1400px 1000px at 50% -200px,#0e1a31 0%,#0b1220 55%,#09101d 100%);
    touch-action:none;
  }
  .minimalOverlay[aria-hidden="false"]{display:flex}
  .minimalTimer{
    margin:auto; font-variant-numeric:tabular-nums; font-weight:900; letter-spacing:1px; user-select:none;
    font-size:clamp(58px, 16vw, 220px);
  }
  body.minimal .app{visibility:hidden}
</style>
</head>
<body>
  <div class="app card">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Locked In ‚Äî Productivity Timer</h1>
          <div class="muted">Tap countdown to reveal main screen. PIN required to end.</div>
        </div>
      </div>
      <div class="pill" id="wakelockStatus">Screen lock: off</div>
    </header>

    <div class="grid">
      <section class="panel">
        <label>Focus duration</label>
        <div class="row" id="presetRow">
          <button class="chip" data-min="25">25m</button>
          <button class="chip" data-min="50">50m</button>
          <button class="chip" data-min="90">90m</button>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div>
            <label>Custom minutes</label>
            <input id="customMinutes" type="number" min="1" max="600" placeholder="e.g. 37" />
          </div>
          <div>
            <label>Required passcode (PIN)</label>
            <input id="pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="Set a PIN to start" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Break plan</label>
          <div class="row">
            <select id="breakPlan">
              <option value="pomodoro">Pomodoro: 25m focus ‚Üí 5m stand/stretch</option>
              <option value="fiftyten">50/10: 50m focus ‚Üí 10m stand/stretch</option>
              <option value="custom">Custom: micro + stand</option>
            </select>
          </div>
          <div id="customBreaks" style="display:none; margin-top:10px; grid-template-columns:1fr 1fr 1fr; gap:10px" class="row">
            <div style="flex:1;min-width:160px">
              <label>Micro break every (min)</label>
              <input id="microEvery" type="number" min="10" max="120" value="20" />
            </div>
            <div style="flex:1;min-width:160px">
              <label>Stand break every (min)</label>
              <input id="standEvery" type="number" min="30" max="240" value="60" />
            </div>
            <div style="flex:1;min-width:160px">
              <label>Stand break length (min)</label>
              <input id="standLen" type="number" min="1" max="15" value="3" />
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Emergency contacts</label>
          <div class="row">
            <input type="tel" id="tel1" placeholder="e.g. 911 or +1 416 555 1234" />
            <input type="tel" id="tel2" placeholder="e.g. Mom" />
            <input type="tel" id="tel3" placeholder="e.g. Doctor" />
          </div>
        </div>

        <div style="margin-top:16px;display:flex;gap:10px;align-items:center">
          <button id="startBtn" class="btn">‚è±Ô∏è Start session</button>
          <button id="testFull" class="btn btn-ghost" title="Try fullscreen">‚§¢ Fullscreen</button>
        </div>
        <p class="note" style="margin-top:10px">
          During focus, only the countdown is visible. <strong>Tap anywhere</strong> to bring the main screen.  
          To <strong>end</strong> the task you <strong>must enter your PIN</strong>. Emergency calls don‚Äôt need a PIN.
        </p>
      </section>

      <section class="panel">
        <div class="timer" id="timer">00:00:00</div>
        <div class="sub" id="phaseLabel">Phase: Focus</div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="endEarly" class="btn btn-ghost">End early</button>
          <button id="pauseResume" class="btn btn-ghost">Pause</button>
          <button id="reset" class="btn btn-ghost">Reset</button>
          <button id="emergencyBtn" class="btn btn-ghost">Emergency</button>
        </div>
      </section>
    </div>

    <section class="panel" style="margin-top:14px">
      <label>Session history</label>
      <div id="history" class="history"></div>
    </section>
  </div>

  <!-- PIN / Emergency sheet -->
  <div id="shield" class="shield" aria-hidden="true">
    <div class="shield-inner" onclick="event.stopPropagation()">
      <span class="pill">Focus session</span>
      <h2 style="margin:0">Enter PIN to confirm</h2>
      <div class="timer" id="timerBig">00:00:00</div>
      <div class="emergency" id="emergencyLinks"></div>
      <div class="note">Emergency calls do not require PIN.</div>
      <input id="pinInput" type="password" inputmode="numeric" placeholder="Enter your PIN"
             style="width:min(360px,90vw);padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0d1729;color:#e5e7eb">
      <div class="keypad" id="keypad"></div>
      <button id="submitPin" class="btn" style="width:min(360px,90vw)">Confirm</button>
      <button id="cancelSheet" class="btn btn-ghost" style="width:min(360px,90vw)">Cancel</button>
    </div>
  </div>

  <!-- Break Shield -->
  <div id="breakShield" class="breakShield" aria-hidden="true">
    <div class="breakBox">
      <span class="pill" id="breakTypePill">Break</span>
      <div class="timer" id="breakTimer">00:00:20</div>
      <div id="breakInstruction" style="text-align:center;max-width:52ch;color:#d1fae5">
        Eye rest: Look ~20 feet away. Do not use your phone.
      </div>
      <div class="progress" style="width:min(520px,92vw)"><div id="breakBar" class="bar"></div></div>
      <div class="holdBtn" id="holdToStart"><div class="holdFill" id="holdFillStart"></div>Tap & hold 1s to start break</div>
      <div class="holdBtn" id="holdToReturn" style="display:none"><div class="holdFill" id="holdFillReturn"></div>Tap & hold 1s to return to focus</div>
    </div>
  </div>

  <!-- Minimal countdown (tap to show main) -->
  <div id="minimal" class="minimalOverlay" aria-hidden="true">
    <div id="minimalTimer" class="minimalTimer">00:00:00</div>
  </div>

  <audio id="ding" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
  </audio>

<script>
/* ---------- State ---------- */
let durationMs = 25*60*1000, remainingMs = durationMs, endAt=null, timerId=null, paused=true;
let wakeLock=null, phase='focus';
let plan='pomodoro', microEveryMin=0, standEveryMin=25, standLenMin=5;
let focusStartAt=null, nextMicroAt=null, nextStandAt=null;
let inBreak=false, breakRemainingMs=0, breakDurationMs=0;
let inactivityTimer=null, pendingAction=null; // 'end'|'pause'|'reset'

/* ---------- DOM ---------- */
const timerEl = document.getElementById('timer'), timerBig=document.getElementById('timerBig');
const bar = document.getElementById('bar'), phaseLabel=document.getElementById('phaseLabel');
const startBtn=document.getElementById('startBtn'), endEarlyBtn=document.getElementById('endEarly');
const pauseResumeBtn=document.getElementById('pauseResume'), resetBtn=document.getElementById('reset');
const emergencyBtn=document.getElementById('emergencyBtn');
const testFull=document.getElementById('testFull'), wakelockStatus=document.getElementById('wakelockStatus');
const customMinutes=document.getElementById('customMinutes'), pinField=document.getElementById('pin');
const historyDiv=document.getElementById('history');
const breakPlan=document.getElementById('breakPlan'), customBreaks=document.getElementById('customBreaks');
const microEvery=document.getElementById('microEvery'), standEvery=document.getElementById('standEvery'), standLen=document.getElementById('standLen');
const breakShield=document.getElementById('breakShield'), shield=document.getElementById('shield');
const breakTimer=document.getElementById('breakTimer'), breakBar=document.getElementById('breakBar');
const breakTypePill=document.getElementById('breakTypePill'), breakInstruction=document.getElementById('breakInstruction');
const holdToStart=document.getElementById('holdToStart'), holdToReturn=document.getElementById('holdToReturn');
const holdFillStart=document.getElementById('holdFillStart'), holdFillReturn=document.getElementById('holdFillReturn');
const minimal=document.getElementById('minimal'), minimalTimer=document.getElementById('minimalTimer');
const pinInput=document.getElementById('pinInput'), submitPin=document.getElementById('submitPin'), cancelSheet=document.getElementById('cancelSheet');
const emergencyLinks=document.getElementById('emergencyLinks');
const tel1=document.getElementById('tel1'), tel2=document.getElementById('tel2'), tel3=document.getElementById('tel3');

/* ---------- Helpers ---------- */
function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; }
function updateMainUI(){
  timerEl.textContent=fmt(remainingMs); timerBig.textContent=fmt(remainingMs); minimalTimer.textContent=fmt(remainingMs);
  const p=100-Math.round((remainingMs/durationMs)*100); bar.style.width=`${Math.min(100,Math.max(0,p))}%`;
  pauseResumeBtn.textContent = paused ? 'Resume' : 'Pause';
  phaseLabel.textContent=`Phase: ${phase==='focus'?'Focus':(phase==='micro'?'Micro break':'Stand/stretch')}`;
}
function updateBreakUI(){ breakTimer.textContent=fmt(breakRemainingMs); const p=100-Math.round((breakRemainingMs/breakDurationMs)*100); breakBar.style.width=`${Math.min(100,Math.max(0,p))}%`; }
function showMinimal(on){ minimal.setAttribute('aria-hidden', on?'false':'true'); document.body.classList.toggle('minimal', on); }
function startInactivityHide(){ clearTimeout(inactivityTimer); inactivityTimer=setTimeout(()=> showMinimal(true), 10000); }
function vibrateShort(){ if(navigator.vibrate) navigator.vibrate([80,40,80]); }
async function goFullscreen(){ try{ if(!document.fullscreenElement){ await document.documentElement.requestFullscreen({navigationUI:'hide'});} }catch{} }
function exitFullscreen(){ if(document.fullscreenElement) document.exitFullscreen().catch(()=>{}); }
async function enableWakeLock(){
  try{
    if('wakeLock' in navigator){
      wakeLock=await navigator.wakeLock.request('screen');
      wakelockStatus.textContent='Screen lock: on';
      wakeLock.addEventListener('release',()=> wakelockStatus.textContent='Screen lock: off');
      document.addEventListener('visibilitychange', async ()=>{
        if(document.visibilityState==='visible' && !wakeLock){
          try{ wakeLock=await navigator.wakeLock.request('screen'); wakelockStatus.textContent='Screen lock: on'; }catch(_){}
        }
      });
    } else { wakelockStatus.textContent='Screen lock: unavailable'; }
  }catch(_){ wakelockStatus.textContent='Screen lock: off'; }
}
function disableWakeLock(){ if(wakeLock){ wakeLock.release().catch(()=>{}); wakeLock=null; wakelockStatus.textContent='Screen lock: off'; } }
function hookUnload(){ window.onbeforeunload=()=> 'Focus session in progress.'; }
function unhookUnload(){ window.onbeforeunload=null; }

/* ---------- History ---------- */
function loadHistory(){ try{return JSON.parse(localStorage.getItem('li_history')||'[]');}catch(_){return [];} }
function saveHistory(list){ localStorage.setItem('li_history', JSON.stringify(list.slice(-100))); }
function addHistory(item){ const list=loadHistory(); list.push(item); saveHistory(list); renderHistory(); }
function renderHistory(){
  const list=loadHistory().slice().reverse();
  historyDiv.innerHTML = list.map(i=>`<div class="hrow"><span>${new Date(i.date).toLocaleString()} ‚Äî ${i.minutes}m ‚Äî ${i.label||'Focus'}</span><span class="${i.outcome==='Completed'?'ok':'bad'}">${i.outcome}</span></div>`).join('') || `<div class="note">No sessions yet.</div>`;
}

/* ---------- Plans & Breaks ---------- */
function applyPlan(){
  const v=breakPlan.value;
  if(v==='pomodoro'){ microEveryMin=0; standEveryMin=durationMs/60000; standLenMin=5; }
  else if(v==='fiftyten'){ microEveryMin=0; standEveryMin=durationMs/60000; standLenMin=10; }
  else { microEveryMin=Math.max(0,+microEvery.value||0); standEveryMin=Math.max(0,+standEvery.value||0); standLenMin=Math.max(1,+standLen.value||3); }
  customBreaks.style.display=(v==='custom')?'grid':'none';
}
function scheduleBreaks(){ const now=Date.now(); focusStartAt=now; nextMicroAt=microEveryMin?now+microEveryMin*60*1000:null; nextStandAt=standEveryMin?now+standEveryMin*60*1000:null; }
function maybeTriggerBreak(now){
  if(inBreak||paused) return;
  if(nextMicroAt && now>=nextMicroAt && phase==='focus'){ startBreak('micro',20*1000,'Eye rest: Look ~20 feet away. Do not use your phone.'); nextMicroAt+=microEveryMin*60*1000; return; }
  if(nextStandAt && now>=nextStandAt && phase==='focus'){ startBreak('stand',standLenMin*60*1000,'Stand and stretch. Hydrate. This is not a phone break.'); nextStandAt+=standEveryMin*60*1000; return; }
}

/* ---------- Session Control ---------- */
function tick(){
  const now=Date.now(); remainingMs=Math.max(0,endAt-now); maybeTriggerBreak(now); updateMainUI();
  if(remainingMs<=0){ clearInterval(timerId); timerId=null; sessionComplete(); }
}
function startSession(){
  if(!pinField.value?.trim()){ alert('Set a PIN before starting.'); return; } // PIN required
  applyPlan();
  if(remainingMs<=0) remainingMs=durationMs;
  endAt=Date.now()+remainingMs; paused=false; phase='focus';
  setEmergencyLinks(); goFullscreen(); enableWakeLock(); hookUnload();
  scheduleBreaks();
  showMinimal(true);
  clearInterval(timerId); timerId=setInterval(tick,200);
  updateMainUI();
}
function pauseSession(){ if(paused) return; paused=true; clearInterval(timerId); timerId=null; remainingMs=Math.max(0,endAt-Date.now()); showMinimal(false); updateMainUI(); }
function resumeSession(){ if(!paused) return; paused=false; endAt=Date.now()+remainingMs; showMinimal(true); clearInterval(timerId); timerId=setInterval(tick,200); updateMainUI(); }
function resetSession(){ clearInterval(timerId); timerId=null; paused=true; endAt=null; remainingMs=durationMs; phase='focus'; showMinimal(false); shield.setAttribute('aria-hidden','true'); breakShield.setAttribute('aria-hidden','true'); inBreak=false; unhookUnload(); disableWakeLock(); exitFullscreen(); updateMainUI(); }
function sessionComplete(){ addHistory({date:new Date().toISOString(), minutes:Math.round(durationMs/60000), outcome:'Completed', label:'Focus'}); showMinimal(false); shield.setAttribute('aria-hidden','true'); breakShield.setAttribute('aria-hidden','true'); inBreak=false; unhookUnload(); disableWakeLock(); exitFullscreen(); const ding=document.getElementById('ding'); if(ding&&ding.play){ ding.play().catch(()=>{});} alert('Nice work ‚Äî session complete!'); remainingMs=durationMs; paused=true; endAt=null; updateMainUI(); }

/* ---------- Break Shield ---------- */
function startBreak(type,lenMs,instruction){
  inBreak=true; phase=type; breakDurationMs=lenMs; breakRemainingMs=lenMs;
  breakTypePill.textContent = type==='micro'?'Micro break':'Stand/stretch';
  breakInstruction.textContent = instruction;
  holdToStart.style.display='block'; holdToReturn.style.display='none';
  holdFillStart.style.width='0%'; holdFillReturn.style.width='0%';
  showMinimal(false); breakShield.setAttribute('aria-hidden','false');
  vibrateShort(); const ding=document.getElementById('ding'); if(ding&&ding.play){ ding.play().catch(()=>{}); }
}
function runBreak(){
  const id=setInterval(()=>{
    breakRemainingMs=Math.max(0,breakRemainingMs-200); updateBreakUI();
    if(breakRemainingMs<=0){ clearInterval(id); holdToStart.style.display='none'; holdToReturn.style.display='block'; vibrateShort(); const ding=document.getElementById('ding'); if(ding&&ding.play){ ding.play().catch(()=>{});} }
  },200);
}
function makeHold(el,fill,onDone){
  const HOLD=1000; let start=0, raf=null;
  function begin(e){ e.preventDefault(); if(raf) cancelAnimationFrame(raf); start=performance.now(); loop(); }
  function loop(){ raf=requestAnimationFrame(ts=>{ const pct=Math.min(1,(ts-start)/HOLD); fill.style.width=(pct*100)+'%'; if(pct>=1){ cancelAnimationFrame(raf); raf=null; onDone(); } else loop(); }); }
  function cancel(){ if(raf){ cancelAnimationFrame(raf); raf=null; fill.style.width='0%'; } }
  ['mousedown','touchstart'].forEach(v=> el.addEventListener(v,begin,{passive:false}));
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(v=> el.addEventListener(v,cancel,{passive:false}));
}
makeHold(holdToStart,holdFillStart,()=> runBreak());
makeHold(holdToReturn,holdFillReturn,()=>{ inBreak=false; phase='focus'; breakShield.setAttribute('aria-hidden','true'); showMinimal(true); updateMainUI(); });

/* ---------- Emergency (no PIN) + PIN Sheet ---------- */
function setEmergencyLinks(){
  emergencyLinks.innerHTML='';
  [tel1.value,tel2.value,tel3.value].filter(Boolean).forEach(t=>{
    const a=document.createElement('a'); a.href=`tel:${t.replace(/\s+/g,'')}`; a.textContent='üö® Emergency Call'; emergencyLinks.appendChild(a);
  });
  if(!emergencyLinks.children.length){ const a=document.createElement('a'); a.href='tel:911'; a.textContent='üö® Emergency Call (911)'; emergencyLinks.appendChild(a); }
}
function openSheet(forAction){ pendingAction=forAction||null; setEmergencyLinks(); shield.setAttribute('aria-hidden','false'); pinInput.value=''; pinInput.focus(); }
function closeSheet(){ shield.setAttribute('aria-hidden','true'); pendingAction=null; }
submitPin.addEventListener('click', ()=>{
  if(pinInput.value === pinField.value){
    if(pendingAction==='end'){ const elapsed=Math.round((durationMs-remainingMs)/60000); addHistory({date:new Date().toISOString(), minutes:elapsed, outcome:'Ended via PIN', label:phase==='focus'?'Focus':'Break'}); resetSession(); }
    else if(pendingAction==='pause'){ pauseSession(); }
    else if(pendingAction==='reset'){ resetSession(); }
    closeSheet();
  }else{
    alert('Incorrect PIN.');
  }
});
cancelSheet.addEventListener('click', closeSheet);

/* ---------- Minimal overlay: tap to show main ---------- */
minimal.addEventListener('click', ()=>{
  if(paused || inBreak) return;
  showMinimal(false);
  startInactivityHide();
});
['mousemove','touchstart','keydown'].forEach(ev=>{
  document.addEventListener(ev, ()=> paused?null:startInactivityHide(), {passive:true});
});

/* ---------- Keypad digits ---------- */
['1','2','3','4','5','6','7','8','9','‚Üê','0','‚ü≤'].forEach(k=>{
  const b=document.createElement('button'); b.className='kbtn'; b.textContent=k;
  b.addEventListener('click',()=>{ if(k==='‚Üê'){ pinInput.value=pinInput.value.slice(0,-1);} else if(k==='‚ü≤'){ pinInput.value=''; } else if(/\d/.test(k)){ pinInput.value+=k; } });
  document.getElementById('keypad').appendChild(b);
});

/* ---------- Controls ---------- */
document.getElementById('presetRow').addEventListener('click',(e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  const min=parseInt(btn.dataset.min,10);
  durationMs=min*60*1000; remainingMs=durationMs; paused=true; endAt=null; phase='focus';
  [...document.querySelectorAll('.chip')].forEach(c=>c.dataset.active='false'); btn.dataset.active='true'; updateMainUI(); applyPlan();
});
customMinutes.addEventListener('input',()=>{
  const v=+customMinutes.value; if(!isNaN(v)&&v>0){ durationMs=v*60*1000; remainingMs=durationMs; paused=true; endAt=null; phase='focus'; updateMainUI(); [...document.querySelectorAll('.chip')].forEach(c=>c.dataset.active='false'); applyPlan(); }
});
breakPlan.addEventListener('change',applyPlan);
[microEvery,standEvery,standLen].forEach(el=> el.addEventListener('input',applyPlan));

startBtn.addEventListener('click', startSession);
testFull.addEventListener('click', goFullscreen);

/* Require PIN for these actions */
endEarlyBtn.addEventListener('click', ()=> openSheet('end'));
pauseResumeBtn.addEventListener('click', ()=> paused ? resumeSession() : openSheet('pause'));
resetBtn.addEventListener('click', ()=> openSheet('reset'));

/* Emergency button opens sheet (for quick access to calls without PIN) */
emergencyBtn.addEventListener('click', ()=> openSheet(null));

/* ---------- Init ---------- */
document.querySelector('.chip[data-min="25"]')?.setAttribute('data-active','true');
renderHistory(); updateMainUI();

/* Prevent scroll behind overlays */
[shield, breakShield, minimal].forEach(el=>{
  el.addEventListener('touchmove', e=> e.preventDefault(), {passive:false});
  el.addEventListener('wheel', e=> e.preventDefault(), {passive:false});
  el.addEventListener('click', e=> e.stopPropagation());
});
</script>
</body>
</html>
